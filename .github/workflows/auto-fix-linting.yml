name: Auto-fix Linting Errors

on:
  pull_request:
    branches: [ main, develop, 'feature/**' ]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-fix:
    name: Auto-fix Ruff errors
    runs-on: ubuntu-latest
    
    # Skip for forks (GITHUB_TOKEN doesn't have write access to forks)
    if: github.event.pull_request.head.repo.full_name == github.repository
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.head_ref }}
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .[dev]
    
    - name: Check for Ruff errors
      id: ruff-check
      continue-on-error: true
      run: |
        ruff check . --output-format=github > ruff-errors.txt || true
        if [ -s ruff-errors.txt ]; then
          echo "has_errors=true" >> $GITHUB_OUTPUT
          cat ruff-errors.txt
        else
          echo "has_errors=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Auto-fix Ruff errors
      if: steps.ruff-check.outputs.has_errors == 'true'
      run: |
        echo "ðŸ”§ Auto-fixing Ruff errors..."
        ruff check --fix .
        ruff format .
    
    - name: Fix unfixable linting errors with heuristics
      if: steps.ruff-check.outputs.has_errors == 'true'
      run: |
        echo "ðŸ¤– Fixing unfixable linting errors using pattern matching and heuristics..."
        python tools/fix_unfixable_lints.py || echo "âš ï¸  Some issues may require manual review"
        
        # Check if any files were modified by the fix script
        if [ -n "$(git status --porcelain)" ]; then
          echo "âœ… Fixed additional linting issues!"
        fi
    
    - name: Check for changes
      id: verify-changed-files
      if: steps.ruff-check.outputs.has_errors == 'true'
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "Changed files:"
          git status --short
        else
          echo "has_changes=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Commit fixes
      if: steps.verify-changed-files.outputs.has_changes == 'true'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add .
        git commit -m "ðŸ”§ Auto-fix Ruff linting errors
        
        Automatically fixed by GitHub Actions workflow.
        Run 'ruff check --fix .' locally to apply these fixes."
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Comment on PR
      if: steps.verify-changed-files.outputs.has_changes == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'âœ… **Auto-fixed Ruff linting errors**\n\nI\'ve automatically fixed Ruff linting errors in this PR. The fixes have been committed to the branch.\n\nTo apply these fixes locally, run:\n```bash\nruff check --fix .\nruff format .\n```'
          })
    
    - name: No errors found
      if: steps.ruff-check.outputs.has_errors == 'false'
      run: |
        echo "âœ… No Ruff linting errors found!"

